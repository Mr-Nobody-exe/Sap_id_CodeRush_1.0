{% load static %}

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Stock Market Dashboard</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f0f2f5;
    }

    .dashboard {
      max-width: 1200px;
      margin: auto;
      padding: 20px;
    }

    header {
      background-color: #333;
      color: white;
      padding: 10px 0;
      text-align: center;
    }

    main {
      display: flex;
      justify-content: space-between;
      margin-top: 20px;
    }

    .left-half{
      display: flex;
      flex-direction: column;
      width: 48%; 
    }

    .watchlist{
      background-color: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      margin-top: 20px;
    }

    .stock-details {
      background-color: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      width: 48%;
    }

    .search-section {
      margin-top: 20px;
      background-color: white;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
    }

    h2 {
      margin-top: 0;
    }

    ul {
      list-style: none;
      padding: 0;
    }

    li {
      padding: 10px;
      border-bottom: 1px solid #ddd;
      cursor: pointer;
      position: relative;
    }

    li:hover {
      background-color: #f0f2f5;
    }

    li button.remove {
      display: none;
      position: absolute;
      right: 10px;
      top: 10px;
      background-color: red;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    li:hover button.remove {
      display: inline-block;
    }

    #stock-info {
      font-size: 1.2em;
    }

    #search {
      width: 100%;
      padding: 10px;
      margin-bottom: 20px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    #stock-table {
      width: 100%;
      border-collapse: collapse;
    }

    #stock-table th, #stock-table td {
      border: 1px solid #ddd;
      padding: 10px;
      text-align: left;
    }

    #stock-table tr:hover{
      background-color: #f0f2f5;
    }

    #stock-table th {
      background-color: #f4f4f4;
    }

    .positive { color: green; }
    .negative { color: red; }

    button.add {
      background-color: green;
      color: white;
      border: none;
      padding: 5px 8px;
      border-radius: 4px;
      cursor: pointer;
    }

    /* Risk Meter */
    .riskMeter {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
      text-align: center;
    }

    .semicircle-wrap {
      position: relative;
      width: 100%;
      max-width: 300px;
      margin: auto;
      aspect-ratio: 2 / 1;
      display: grid;
      place-items: center;
    }

    .progress {
      transition: stroke-dashoffset .6s ease;
      stroke-dasharray: 0 1;
    }

    .label {
      position: absolute;
      bottom: 8%;
      text-align: center;
      font-weight: bold;
      font-size: 1.5rem;
      color: #333;
    }

    .label .sub {
      display: block;
      font-size: 0.9rem;
      color: #666;
    }

    #action-section {
      margin-top: 15px;
      border-top: 1px solid #eee;
      padding-top: 10px;
    }

    #action { font-size: 1.1em; font-weight: bold; }
    #action.buy { color: green; }
    #action.sell { color: red; }
    #action.hold { color: blue; }
    #explanation { font-size: 0.9em; color: #555; }

  </style>
</head>
<body>
  <div class="dashboard">
    <header>
      <h1>User's Profile</h1>
    </header>

    <main>
      <div class="left-half">
        <!-- Risk Meter -->
        <div class="riskMeter">
          <h2>Risk Meter</h2>
          <div class="semicircle-wrap">
            <svg viewBox="0 0 100 50" width="100%" height="100%">
              <path id="arc-track" d="M 10 50 A 40 40 0 0 1 90 50"
                fill="none" stroke="#eee" stroke-width="10" stroke-linecap="round"/>
              <path id="arc-progress" class="progress"
                d="M 10 50 A 40 40 0 0 1 90 50"
                fill="none" stroke="url(#grad)" stroke-width="10" stroke-linecap="round"/>
              <defs>
                <linearGradient id="grad" x1="0%" y1="100%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#6a5acd"/>
                  <stop offset="100%" stop-color="#00b3ff"/>
                </linearGradient>
              </defs>
            </svg>
            <div class="label">
              <span id="percent">0%</span>
              <span class="sub">risk level</span>
            </div>
          </div>

          <div id="action-section">
            <h3 id="action" class="hold">Hold</h3>
            <p id="explanation">Select a stock to see recommendations.</p>
          </div>
        </div>

        <!-- Watchlist -->
        <div class="watchlist">
          <h2>Current Stock</h2>
          <ul id="watchlist"></ul>
        </div>
      </div>

      <div class="stock-details">
        <h2>Stock Overview</h2>
        <div id="stock-info"></div>
      </div>
    </main>

    <section class="search-section">
      <input type="text" id="search" placeholder="Search for stocks...">
      <table id="stock-table">
        <thead>
          <tr>
            <th>Stock Name</th>
            <th>Price</th>
            <th>Change</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const watchlist = document.getElementById('watchlist');
      const stockInfo = document.getElementById('stock-info');
      const searchInput = document.getElementById('search');
      const stockTableBody = document.querySelector('#stock-table tbody');
      const actionEl = document.getElementById('action');
      const explanationEl = document.getElementById('explanation');

      let watchlistStocks = []; // start empty

      const allStocks = [
        { symbol: 'AAPL', name: 'Apple Inc.', price: 150.54, change: 0.5 },
        { symbol: 'GOOGL', name: 'Alphabet Inc.', price: 2800.66, change: -1.2 },
        { symbol: 'AMZN', name: 'Amazon.com Inc.', price: 3401.46, change: 2.1 },
        { symbol: 'MSFT', name: 'Microsoft Corporation', price: 299.35, change: -0.3 },
        { symbol: 'TSLA', name: 'Tesla Inc.', price: 720.25, change: 0.8 }
      ];

      function fetchRiskMetrics(symbol) {
        return new Promise(resolve => {
          setTimeout(() => {
            resolve({
              VaR_95: Math.random().toFixed(4),
              CVaR_95: Math.random().toFixed(4),
              Volatility: Math.random().toFixed(4),
              Sentiment: (Math.random()*2-1).toFixed(2),
              Risk_Percent: Math.floor(Math.random()*100),
              Suggested_Action: ["Buy","Sell","Hold"][Math.floor(Math.random()*3)],
              Explanation: "This is a generated explanation for " + symbol
            });
          }, 200);
        });
      }

      function displayStockInfo(stock) {
        fetchRiskMetrics(stock.symbol).then(data => {
          const changeClass = data.Sentiment >= 0 ? 'positive' : 'negative';
          stockInfo.innerHTML = `
            <h3>${stock.name} (${stock.symbol})</h3>
            <p>Sentiment Score: <span class="${changeClass}">${data.Sentiment}</span></p>
            <p>VaR(95): ${data.VaR_95}</p>
            <p>CVaR(95): ${data.CVaR_95}</p>
            <p>Volatility: ${data.Volatility}</p>
          `;

          if (window.setRiskLevel) window.setRiskLevel(data.Risk_Percent);

          actionEl.textContent = data.Suggested_Action;
          actionEl.className = data.Suggested_Action.toLowerCase();
          explanationEl.textContent = data.Explanation;
        });
      }

      function updateWatchlist() {
        watchlist.innerHTML = '';
        watchlistStocks.forEach(stock => {
          const li = document.createElement('li');
          li.textContent = `${stock.name} (${stock.symbol})`;

          li.addEventListener('click', () => displayStockInfo(stock));

          // Remove button
          const removeBtn = document.createElement('button');
          removeBtn.textContent = 'Remove';
          removeBtn.className = 'remove';
          removeBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            watchlistStocks = watchlistStocks.filter(s => s.symbol !== stock.symbol);
            updateWatchlist();
          });
          li.appendChild(removeBtn);
          watchlist.appendChild(li);
        });
      }

      function addToWatchlist(stock) {
        if (!watchlistStocks.find(s => s.symbol === stock.symbol)) {
          watchlistStocks.push(stock);
          updateWatchlist();
        }
      }

      function displayStockTable(stocks) {
        stockTableBody.innerHTML = '';
        stocks.forEach(stock => {
          const tr = document.createElement('tr');
          tr.innerHTML = `
            <td>${stock.name}</td>
            <td>$${stock.price.toFixed(1)}</td>
            <td>${stock.change}%</td>
            <td><button class="add">Add</button></td>
          `;

          tr.addEventListener('click', (e) => {
            if (e.target.classList.contains('add')) return;
            displayStockInfo(stock);
          });

          const addButton = tr.querySelector('.add');
          addButton.addEventListener('click', (e) => {
            e.stopPropagation();
            addToWatchlist(stock);
          });

          stockTableBody.appendChild(tr);
        });
      }

      searchInput.addEventListener('input', e => {
        const searchTerm = e.target.value.toLowerCase();
        const filtered = allStocks.filter(s =>
          s.name.toLowerCase().includes(searchTerm) ||
          s.symbol.toLowerCase().includes(searchTerm)
        );
        displayStockTable(filtered);
      });

      displayStockTable(allStocks);
      updateWatchlist();

    });

    // Risk Meter JS
    document.addEventListener('DOMContentLoaded', () => {
      const arc = document.getElementById('arc-progress');
      const percentText = document.getElementById('percent');
      const arcLength = arc.getTotalLength();
      arc.style.strokeDasharray = arcLength + " " + arcLength;

      function setRiskLevel(pct) {
        pct = Math.max(0, Math.min(100, pct));
        const offset = arcLength * (1 - pct / 100);
        arc.style.strokeDashoffset = offset;
        percentText.textContent = pct + "%";
      }
      window.setRiskLevel = setRiskLevel;
      setRiskLevel(0);
    });
  </script>
</body>
</html>
